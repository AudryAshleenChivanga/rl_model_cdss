<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>H. pylori CDSS 3D Endoscopy RL Simulator</title>
    <link rel="stylesheet" href="styles.css">
    <script src="https://cdnjs.cloudflare.com/ajax/libs/three.js/r128/three.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/three@0.128.0/examples/js/loaders/GLTFLoader.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/three@0.128.0/examples/js/controls/OrbitControls.js"></script>
</head>
<body>
    <!-- Research Disclaimer Banner -->
    <div class="disclaimer-banner">
        <div class="disclaimer-content">
            <strong>RESEARCH PROTOTYPE - NOT A MEDICAL DEVICE</strong>
        </div>
        <div class="disclaimer-text">
            This system is for research and simulation purposes only. Not for clinical use or patient care.
        </div>
    </div>

    <div class="container">
        <!-- Header -->
        <header>
            <h1>H. pylori CDSS - 3D Endoscopy RL Simulator</h1>
            <p class="subtitle">Reinforcement Learning for Virtual Endoscopy Navigation & Anomaly Detection</p>
        </header>

        <!-- Main Content -->
        <div class="main-content">
            <!-- Left Panel: Controls and Setup -->
            <div class="left-panel">
                <div class="panel">
                    <h2>Controls</h2>
                    
                    <!-- Model Loading -->
                    <div class="control-group">
                        <label for="gltf-url">GLTF Model URL:</label>
                        <input 
                            type="text" 
                            id="gltf-url" 
                            placeholder="https://example.com/digestive_system.gltf"
                            value="models/digestive/source/scene.gltf"
                        >
                        <button id="load-model-btn" class="btn btn-primary">Load Model</button>
                        <p class="note">Digestive System model from <a href="https://skfb.ly/oPDYC" target="_blank">Sketchfab (adimed)</a> - CC Attribution. Try Duck model: <a href="#" onclick="document.getElementById('gltf-url').value='https://raw.githubusercontent.com/KhronosGroup/glTF-Sample-Models/master/2.0/Duck/glTF/Duck.gltf'; return false;">Click here</a></p>
                    </div>

                    <!-- Clinical Scenario Selection -->
                    <div class="control-group">
                        <label for="scenario-select">Clinical Scenario:</label>
                        <select id="scenario-select" class="scenario-select">
                            <option value="">Loading scenarios...</option>
                        </select>
                        <p class="scenario-description" id="scenario-description">Select a clinical scenario to simulate</p>
                    </div>

                    <!-- Simulation Controls -->
                    <div class="control-group">
                        <button id="start-btn" class="btn btn-success" disabled>Start Simulation</button>
                        <button id="stop-btn" class="btn btn-danger" disabled>Stop</button>
                        <button id="reset-btn" class="btn btn-secondary">Reset</button>
                    </div>

                    <!-- Status -->
                    <div class="status-group">
                        <h3>Status</h3>
                        <div class="status-item">
                            <span class="status-label">Connection:</span>
                            <span id="connection-status" class="status-value">Disconnected</span>
                        </div>
                        <div class="status-item">
                            <span class="status-label">Simulation:</span>
                            <span id="sim-status" class="status-value">Stopped</span>
                        </div>
                        <div class="status-item">
                            <span class="status-label">Model:</span>
                            <span id="model-status" class="status-value">Not Loaded</span>
                        </div>
                    </div>
                </div>

                <!-- Info Panel -->
                <div class="panel">
                    <h2>Information</h2>
                    <div class="info-content">
                        <h3>About</h3>
                        <p>This simulator combines:</p>
                        <ul>
                            <li>Custom Gymnasium environment</li>
                            <li>ResNet18 anomaly detector</li>
                            <li>PPO navigation policy</li>
                            <li>Real-time 3D visualization</li>
                        </ul>
                        <h3>Usage</h3>
                        <ol>
                            <li>Paste GLTF model URL</li>
                            <li>Click "Load Model"</li>
                            <li>Click "Start Simulation"</li>
                            <li>Watch live stream & metrics</li>
                        </ol>
                    </div>
                </div>
            </div>

            <!-- Center Panel: Video Feed -->
            <div class="center-panel">
                <div class="panel">
                    <h2>Live Camera Feed</h2>
                    <div class="video-container">
                        <canvas id="video-canvas"></canvas>
                        <div id="loading-overlay" class="loading-overlay">
                            <div class="spinner"></div>
                            <p>Waiting for stream...</p>
                        </div>
                    </div>
                    
                    <!-- Frame Info -->
                    <div class="frame-info">
                        <div class="info-item">
                            <span class="label">Step:</span>
                            <span id="step-value">0</span>
                        </div>
                        <div class="info-item">
                            <span class="label">FPS:</span>
                            <span id="fps-value">0</span>
                        </div>
                        <div class="info-item">
                            <span class="label">Coverage:</span>
                            <span id="coverage-value">0.0%</span>
                        </div>
                    </div>
                </div>

                <!-- Three.js Visualization -->
                <div class="panel">
                    <h2>3D Camera Path</h2>
                    <div id="threejs-container"></div>
                </div>
            </div>

            <!-- Right Panel: Metrics -->
            <div class="right-panel">
                <!-- CNN Prediction -->
                <div class="panel">
                    <h2>CNN Anomaly Detection</h2>
                    <div class="metric-display">
                        <div class="metric-label">Lesion Probability</div>
                        <div id="cnn-prob" class="metric-value large">0.00</div>
                        <div id="cnn-gauge" class="gauge">
                            <div id="cnn-gauge-fill" class="gauge-fill"></div>
                        </div>
                        <div id="cnn-status" class="status-indicator normal">Normal</div>
                    </div>
                </div>

                <!-- RL Action -->
                <div class="panel">
                    <h2>RL Policy Guidance</h2>
                    <div class="metric-display">
                        <div class="metric-label">Suggested Action</div>
                        <div id="action-name" class="action-badge">-</div>
                        <div class="metric-label">Action ID</div>
                        <div id="action-id" class="metric-value">-</div>
                    </div>
                </div>

                <!-- Reward -->
                <div class="panel">
                    <h2>Reward Metrics</h2>
                    <div class="metric-display">
                        <div class="metric-label">Step Reward</div>
                        <div id="step-reward" class="metric-value">0.00</div>
                        <div class="metric-label">Total Reward</div>
                        <div id="total-reward" class="metric-value">0.00</div>
                    </div>
                </div>

                <!-- Camera Pose -->
                <div class="panel">
                    <h2>Camera Position</h2>
                    <div class="pose-display">
                        <div class="pose-item">
                            <span class="pose-label">Position:</span>
                            <span id="position-value" class="pose-value">x:0 y:0 z:0</span>
                        </div>
                        <div class="pose-item">
                            <span class="pose-label">Rotation:</span>
                            <span id="rotation-value" class="pose-value">r:0 p:0 y:0</span>
                        </div>
                        <div class="pose-item">
                            <span class="pose-label">Collision:</span>
                            <span id="collision-value" class="pose-value">No</span>
                        </div>
                    </div>
                </div>

                <!-- Session Controls -->
                <div class="panel">
                    <h2>Session Data</h2>
                    <button id="download-btn" class="btn btn-secondary full-width">
                        Download Metrics
                    </button>
                    <div class="metric-display">
                        <div class="metric-label">Frames Received</div>
                        <div id="frames-count" class="metric-value">0</div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Footer -->
    <footer>
        <p>RESEARCH PROTOTYPE - NOT A MEDICAL DEVICE - FOR SIMULATION ONLY</p>
        <p>&copy; 2025 H. pylori RL Simulator | MIT License | Research Use Only</p>
    </footer>

    <!-- Load App Script -->
    <script src="app.js"></script>
</body>
</html>

